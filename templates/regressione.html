{% extends "base_clean.html" %}

{% block title %}Regressione - PL-AI Platform{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Regressione Lineare</h1>
        <p class="text-gray-600">Carica un dataset CSV con due colonne per creare un modello di regressione lineare.</p>
    </div>

    <!-- Main Content -->
    <div class="bg-white rounded-lg shadow-lg p-8">
        <!-- File Upload Section -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4">1. Carica il Dataset</h2>
            <div class="flex items-center space-x-4">
                <input type="file" id="csvFile" accept=".csv" class="hidden">
                <label for="csvFile" class="bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-blue-700 transition duration-150">
                    Seleziona File CSV
                </label>
                <span id="fileName" class="text-gray-600"></span>
            </div>
            <p class="mt-2 text-sm text-gray-500">Il file deve contenere due colonne: variabile indipendente (X) e variabile dipendente (Y)</p>
        </div>

        <!-- Model Results Section -->
        <div id="modelResults" class="hidden mb-8">
            <h2 class="text-xl font-semibold mb-4">2. Risultati del Modello</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-medium mb-2">Coefficiente</h3>
                    <p id="coefficient" class="text-2xl font-bold text-blue-600"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-medium mb-2">Intercetta</h3>
                    <p id="intercept" class="text-2xl font-bold text-blue-600"></p>
                </div>
            </div>
        </div>

        <!-- Prediction Section -->
        <div id="predictionSection" class="hidden mb-8">
            <h2 class="text-xl font-semibold mb-4">3. Fai una Predizione</h2>
            <div class="flex items-end space-x-4">
                <div class="flex-1">
                    <label for="predictionInput" class="block text-sm font-medium text-gray-700 mb-1">Valore X</label>
                    <input type="number" id="predictionInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="predictBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-150">
                    Predici
                </button>
            </div>
            <div id="predictionResult" class="mt-4 hidden">
                <h3 class="font-medium mb-2">Risultato della Predizione</h3>
                <p id="predictionValue" class="text-2xl font-bold text-green-600"></p>
            </div>
        </div>

        <!-- Plot Section -->
        <div id="plotSection" class="hidden">
            <h2 class="text-xl font-semibold mb-4">4. Visualizzazione</h2>
            <div id="regressionPlot" class="w-full h-96 border border-gray-200 rounded-lg"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // DOM Elements
    const csvFile = document.getElementById('csvFile');
    const fileName = document.getElementById('fileName');
    const modelResults = document.getElementById('modelResults');
    const coefficient = document.getElementById('coefficient');
    const intercept = document.getElementById('intercept');
    const predictionSection = document.getElementById('predictionSection');
    const predictionInput = document.getElementById('predictionInput');
    const predictBtn = document.getElementById('predictBtn');
    const predictionResult = document.getElementById('predictionResult');
    const predictionValue = document.getElementById('predictionValue');
    const plotSection = document.getElementById('plotSection');
    const regressionPlot = document.getElementById('regressionPlot');

    let currentModel = null;

    // File Upload Handler
    csvFile.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        fileName.textContent = file.name;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/upload-regression', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (data.error) {
                alert(data.error);
                return;
            }

            // Save model parameters
            currentModel = {
                coefficiente: data.coefficiente,
                intercetta: data.intercetta
            };

            // Show results
            modelResults.classList.remove('hidden');
            coefficient.textContent = data.coefficiente.toFixed(4);
            intercept.textContent = data.intercetta.toFixed(4);
            predictionSection.classList.remove('hidden');
            plotSection.classList.remove('hidden');

            // Create plot
            const xValues = Array.from({length: 100}, (_, i) => i - 50);
            const yValues = xValues.map(x => data.coefficiente * x + data.intercetta);

            const trace1 = {
                x: xValues,
                y: yValues,
                type: 'scatter',
                mode: 'lines',
                name: 'Linea di Regressione',
                line: {
                    color: 'rgb(37, 99, 235)'
                }
            };

            const layout = {
                title: 'Linea di Regressione',
                xaxis: {
                    title: 'X'
                },
                yaxis: {
                    title: 'Y'
                }
            };

            Plotly.newPlot('regressionPlot', [trace1], layout);

        } catch (error) {
            console.error('Error:', error);
            alert('Errore durante il caricamento del file');
        }
    });

    // Prediction Handler
    predictBtn.addEventListener('click', async () => {
        if (!currentModel) return;

        const value = parseFloat(predictionInput.value);
        if (isNaN(value)) {
            alert('Inserisci un numero valido');
            return;
        }

        try {
            const response = await fetch('/predict-regression', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    value: value,
                    coefficiente: currentModel.coefficiente,
                    intercetta: currentModel.intercetta
                })
            });

            const data = await response.json();
            if (data.error) {
                alert(data.error);
                return;
            }

            predictionResult.classList.remove('hidden');
            predictionValue.textContent = data.prediction.toFixed(4);

            // Add point to plot
            const trace2 = {
                x: [value],
                y: [data.prediction],
                type: 'scatter',
                mode: 'markers',
                name: 'Predizione',
                marker: {
                    size: 10,
                    color: 'rgb(22, 163, 74)'
                }
            };

            Plotly.addTraces('regressionPlot', trace2);

        } catch (error) {
            console.error('Error:', error);
            alert('Errore durante la predizione');
        }
    });
</script>
{% endblock %}
