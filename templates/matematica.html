{% extends "base.html" %}

{% block content %}
<style>
    .math-formula {
        background-color: #1a365d;
        color: #e2e8f0;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin: 1.5rem 0;
        font-family: 'Computer Modern', serif;
        overflow-x: auto;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #2d4a7c;
    }
    
    .math-formula p {
        margin: 0;
        font-size: 1.1em;
        line-height: 1.6;
    }
    
    .math-formula pre {
        margin: 0;
        white-space: pre-wrap;
    }

    /* Spinner styles */
    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div class="max-w-7xl mx-auto px-4">
    
    <!-- Progress Summary -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8 hidden" id="progress-summary">
        <h3 class="text-lg font-semibold mb-4">Il tuo progresso</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="progress-stats">
            <!-- Dynamically populated -->
        </div>
    </div>

    <!-- Selection Panel -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Grade Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Grado Scolastico</label>
                <select id="grade-select" class="form-select">
                    <option value="primaria">Scuola Primaria</option>
                    <option value="media">Scuola Secondaria I°</option>
                    <option value="superiori">Scuola Secondaria II°</option>
                </select>
            </div>
            
            <!-- Subject Area -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Macroarea</label>
                <select id="subject-select" class="form-select">
                    <option value="aritmetica">Aritmetica</option>
                    <option value="algebra">Algebra</option>
                    <option value="geometria">Geometria</option>
                </select>
            </div>
            
            <!-- Topic Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Argomento</label>
                <select id="topic-select" class="form-select">
                    <!-- Dynamically populated -->
                </select>
            </div>
        </div>
        
        <button id="start-lesson" class="btn mt-6">
            Inizia Lezione
        </button>
    </div>

    <!-- Spinner -->
    <div id="spinner" class="spinner hidden"></div>

    <!-- Lesson Section -->
    <div id="lesson-container" class="bg-white rounded-lg shadow-md p-6 mb-8 hidden">
        <div class="prose max-w-none">
            <h3 class="text-xl font-semibold mb-4">Mini Lezione</h3>
            <div id="lesson-content" class="text-lg mb-6"></div>
            
            <button id="start-exercise" class="btn mt-4">
                Inizia Esercizio
            </button>
        </div>
    </div>

    <!-- Exercise Display -->
    <div id="exercise-container" class="bg-white rounded-lg shadow-md p-6 hidden">
        <div class="prose max-w-none">
            <h3 class="text-xl font-semibold mb-4">Esercizio</h3>
            <div id="exercise-content" class="text-lg mb-6"></div>
            
            <!-- Exercise Type Selection -->
            <div id="exercise-type-selector" class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo di Esercizio</label>
                <select id="exercise-type" class="form-select">
                    <option value="fill">Esercizio Compilativo</option>
                    <option value="text">Risposta Testuale</option>
                    <option value="image">Carica Immagine</option>
                </select>
            </div>
            
            <!-- Answer Input Section -->
            <div id="answer-section" class="border-t pt-4">
                <!-- Fill-in-the-blank answer -->
                <div id="fill-answer" class="answer-type">
                    <label class="block text-sm font-medium text-gray-700 mb-2">La tua risposta</label>
                    <input type="text" id="fill-input" class="form-input" placeholder="Inserisci la tua risposta">
                </div>
                
                <!-- Text answer -->
                <div id="text-answer" class="answer-type hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">La tua risposta</label>
                    <textarea id="text-input" class="form-textarea" rows="4" placeholder="Scrivi la tua risposta in italiano"></textarea>
                </div>
                
                <!-- Image upload -->
                <div id="image-answer" class="answer-type hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Carica l'immagine della tua soluzione</label>
                    <input type="file" id="image-input" accept="image/*" class="form-input">
                    <div id="image-preview" class="mt-4 hidden">
                        <img id="preview-img" class="max-w-md rounded-lg shadow-md" alt="Anteprima">
                    </div>
                </div>
                
                <button id="check-answer" class="btn mt-4">
                    Verifica Risposta
                </button>
            </div>
            
            <div id="feedback" class="mt-6 hidden"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// Complete topic and exercise database
const topicsDatabase = {
    primaria: {
        aritmetica: ["Addizioni", "Sottrazioni", "Moltiplicazioni", "Divisioni", "Frazioni"],
        algebra: ["Espressioni semplici", "Proprietà delle operazioni"],
        geometria: ["Forme geometriche", "Perimetro", "Area"]
    },
    media: {
        aritmetica: ["Frazioni", "Percentuali", "Proporzioni"],
        algebra: ["Equazioni I grado", "Polinomi", "Sistemi"],
        geometria: ["Teorema di Pitagora", "Aree e volumi", "Trasformazioni"]
    },
    superiori: {
        aritmetica: ["Logaritmi", "Radicali", "Progressioni"],
        algebra: ["Equazioni II grado", "Disequazioni", "Funzioni"],
        geometria: ["Geometria analitica", "Trigonometria", "Geometria solida"]
    }
};

// Update topics based on selections
function updateTopics() {
    const grade = document.getElementById('grade-select').value;
    const subject = document.getElementById('subject-select').value;
    const topicSelect = document.getElementById('topic-select');
    
    // Reset exercise container when changing topics
    document.getElementById('exercise-container').classList.add('hidden');
    document.getElementById('exercise-content').innerHTML = '';
    document.getElementById('feedback').classList.add('hidden');
    document.getElementById('feedback').innerHTML = '';
    
    topicSelect.innerHTML = '';
    topicsDatabase[grade][subject].forEach(topic => {
        const option = document.createElement('option');
        option.value = topic.toLowerCase().replace(' ', '-');
        option.textContent = topic;
        topicSelect.appendChild(option);
    });
}

// Handle exercise type changes
document.getElementById('exercise-type').addEventListener('change', function() {
    const type = this.value;
    document.querySelectorAll('.answer-type').forEach(el => el.classList.add('hidden'));
    document.getElementById(`${type}-answer`).classList.remove('hidden');
});

// Handle image upload preview
document.getElementById('image-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('preview-img');
            preview.src = e.target.result;
            document.getElementById('image-preview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
});

// Format mathematical content
function formatMathContent(content) {
    // First, convert Markdown to HTML
    let htmlContent = marked.parse(content);

    // Then, find and wrap LaTeX formulas
    // Regex to find inline LaTeX \(...\) and display LaTeX \[...\] or $$...$$
    const latexRegex = /(\\\(.*?\\\)|\\[.*?\\]|\$\$.*?\$\$)/gs;
    
    return htmlContent.replace(latexRegex, (match) => {
        // Remove the LaTeX delimiters before wrapping
        let formula = match;
        if (match.startsWith('\\(') && match.endsWith('\\)')) {
            formula = match.slice(2, -2);
        } else if (match.startsWith('\\[') && match.endsWith('\\]')) {
            formula = match.slice(2, -2);
        } else if (match.startsWith('$$') && match.endsWith('$$')) {
            formula = match.slice(2, -2);
        }
        
        return `<div class="math-formula">${formula}</div>`;
    });
}

// Function to get a unique key for a lesson
function getLessonKey(grade, subject, topic) {
    return `lesson_${grade}_${subject}_${topic}`;
}

// Function to save a lesson to localStorage
function saveLesson(grade, subject, topic, lesson) {
    const key = getLessonKey(grade, subject, topic);
    localStorage.setItem(key, JSON.stringify(lesson));
}

// Function to get a lesson from localStorage
function getLesson(grade, subject, topic) {
    const key = getLessonKey(grade, subject, topic);
    const lesson = localStorage.getItem(key);
    return lesson ? JSON.parse(lesson) : null;
}

// Start lesson
document.getElementById('start-lesson').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    const spinner = document.getElementById('spinner');
    spinner.classList.remove('hidden');
    
    try {
        const grade = document.getElementById('grade-select').value;
        const subject = document.getElementById('subject-select').value;
        const topic = document.getElementById('topic-select').value;

        // Check if lesson exists in localStorage
        let lesson = getLesson(grade, subject, topic);
        let isNewLesson = false;

        if (!lesson) {
            // Generate new lesson
            const response = await fetch('/api/generate-lesson', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ grade, subject, topic })
            });
            
            const data = await response.json();
            
            if (!response.ok || data.status === 'error') {
                throw new Error(data.message || 'Errore nella generazione della lezione');
            }
            
            if (data.status === 'success' && data.lesson) {
                lesson = data.lesson;
                saveLesson(grade, subject, topic, lesson);
                isNewLesson = true;
            } else {
                throw new Error('Formato risposta non valido');
            }
        }

        const formattedLesson = formatMathContent(lesson);
        document.getElementById('lesson-content').innerHTML = formattedLesson;
        document.getElementById('lesson-container').classList.remove('hidden');
        
        if(window.MathJax) {
            MathJax.typeset();
        }

        // If it's a new lesson, show a message
        if (isNewLesson) {
            console.log('Nuova lezione generata e salvata.');
        } else {
            console.log('Lezione recuperata dal database.');
        }

    } catch (error) {
        console.error('Error:', error);
        document.getElementById('lesson-content').innerHTML = `
            <div class="text-red-600 p-4">
                ${error.message}
            </div>
        `;
    } finally {
        btn.disabled = false;
        spinner.classList.add('hidden');
    }
});

// Start exercise
document.getElementById('start-exercise').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    const spinner = document.getElementById('spinner');
    spinner.classList.remove('hidden');
    
    try {
        const grade = document.getElementById('grade-select').value;
        const subject = document.getElementById('subject-select').value;
        const topic = document.getElementById('topic-select').value;
        const exerciseType = document.getElementById('exercise-type').value;

        const response = await fetch('/api/generate-exercise', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ grade, subject, topic, exerciseType })
        });
        
        const data = await response.json();
        
        if (!response.ok || data.status === 'error') {
            throw new Error(data.message || 'Errore nella generazione dell\'esercizio');
        }
        
        const formattedExercise = formatMathContent(data.exercise);
        document.getElementById('exercise-content').innerHTML = formattedExercise;
        document.getElementById('exercise-container').classList.remove('hidden');
        document.getElementById('exercise-content').dataset.correctAnswer = data.answer;
        
        if(window.MathJax) {
            MathJax.typeset();
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('exercise-content').innerHTML = `
            <div class="text-red-600 p-4">
                ${error.message}
            </div>
        `;
    } finally {
        btn.disabled = false;
        spinner.classList.add('hidden');
    }
});

// Check answer
document.getElementById('check-answer').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    
    try {
        const exerciseType = document.getElementById('exercise-type').value;
        let answer;
        
        switch(exerciseType) {
            case 'fill':
                answer = document.getElementById('fill-input').value.trim();
                break;
            case 'text':
                answer = document.getElementById('text-input').value.trim();
                break;
            case 'image':
                const fileInput = document.getElementById('image-input');
                if (!fileInput.files.length) {
                    throw new Error('Per favore carica un\'immagine');
                }
                const formData = new FormData();
                formData.append('image', fileInput.files[0]);
                formData.append('exerciseType', exerciseType);
                formData.append('correctAnswer', document.getElementById('exercise-content').dataset.correctAnswer);
                
                const response = await fetch('/api/check-image-answer', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (!response.ok || result.status === 'error') {
                    throw new Error(result.message || 'Errore nella verifica dell\'immagine');
                }
                
                showFeedback(result.isCorrect, result.feedback);
                return;
        }
        
        const response = await fetch('/api/check-answer', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                answer,
                exerciseType,
                correctAnswer: document.getElementById('exercise-content').dataset.correctAnswer
            })
        });
        
        const result = await response.json();
        if (!response.ok || result.status === 'error') {
            throw new Error(result.message || 'Errore nella verifica della risposta');
        }
        
        showFeedback(result.isCorrect, result.feedback);
        
    } catch (error) {
        console.error('Error:', error);
        showFeedback(false, error.message);
    } finally {
        btn.disabled = false;
    }
});

function showFeedback(isCorrect, message) {
    const feedback = document.getElementById('feedback');
    feedback.innerHTML = `
        <div class="p-4 ${isCorrect ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'} rounded">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="${isCorrect ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12'}"/>
            </svg>
            ${message}
        </div>
    `;
    feedback.classList.remove('hidden');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateTopics();
    document.getElementById('grade-select').addEventListener('change', updateTopics);
    document.getElementById('subject-select').addEventListener('change', updateTopics);
});
</script>
{% endblock %}
