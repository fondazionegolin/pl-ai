{% extends "base_with_console.html" %}

{% block console_content %}
<!-- Override del blocco console per nasconderla completamente -->
{% endblock %}

{% block main_content %}
<!-- CSS per nascondere completamente la console -->
<style>
    /* Nascondi completamente la console */
    #console-container {
        display: none !important;
    }
    
    /* Assicura che il contenuto principale occupi tutto lo spazio disponibile */
    #main-content-container {
        grid-column: 1 / -1 !important;
        padding-left: 0 !important;
        padding-bottom: 0 !important; /* Rimuovi il padding inferiore che lascerebbe spazio per la console */
    }
</style>

<!-- Add Marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Add Highlight.js for code syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<!-- Contenitore delle notifiche -->
<div id="notifications-container" class="fixed top-5 right-5 z-50 flex flex-col gap-3 w-80"></div>

<!-- Tutorial Modal -->
<div id="tutorial-modal" class="fixed inset-0 bg-black bg-opacity-30 z-50 hidden justify-center items-center">
    <div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-medium text-gray-900">Guida all'utilizzo del Chatbot Didattico</h3>
            <button id="tutorial-close" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <div class="space-y-6">
            <div>
                <h4 class="text-md font-medium text-gray-800 mb-2 flex items-center">
                    <span class="bg-blue-100 text-blue-800 font-bold rounded-full h-6 w-6 flex items-center justify-center mr-2">1</span>
                    Configura il tuo assistente
                </h4>
                <p class="text-gray-600 ml-8">Seleziona <strong>grado scolastico</strong>, <strong>modalità</strong>, <strong>materia</strong> e <strong>modello AI</strong> in base alle tue esigenze. Ogni selezione personalizza l'assistente per un'esperienza ottimale.</p>
            </div>
            
            <div>
                <h4 class="text-md font-medium text-gray-800 mb-2 flex items-center">
                    <span class="bg-blue-100 text-blue-800 font-bold rounded-full h-6 w-6 flex items-center justify-center mr-2">2</span>
                    Scegli una modalità
                </h4>
                <div class="ml-8 space-y-2">
                    <p class="text-gray-600"><strong>• Interrogazione:</strong> L'assistente ti pone domande sull'argomento per verificare la tua conoscenza.</p>
                    <p class="text-gray-600"><strong>• Intervista:</strong> Simula un'intervista con un personaggio storico o un esperto del settore.</p>
                    <p class="text-gray-600"><strong>• Domande e risposte:</strong> Risposte dirette alle tue domande specifiche sull'argomento.</p>
                    <p class="text-gray-600"><strong>• Spiegazione:</strong> Spiegazioni dettagliate di concetti complessi, adattate al tuo livello.</p>
                </div>
            </div>
            
            <div>
                <h4 class="text-md font-medium text-gray-800 mb-2 flex items-center">
                    <span class="bg-blue-100 text-blue-800 font-bold rounded-full h-6 w-6 flex items-center justify-center mr-2">3</span>
                    Inserisci il contesto
                </h4>
                <p class="text-gray-600 ml-8">Fornisci ulteriori dettagli nell'area di testo per personalizzare l'interazione. Ad esempio, specifica l'argomento su cui vuoi essere interrogato o il personaggio che desideri intervistare.</p>
            </div>
            
            <div>
                <h4 class="text-md font-medium text-gray-800 mb-2 flex items-center">
                    <span class="bg-blue-100 text-blue-800 font-bold rounded-full h-6 w-6 flex items-center justify-center mr-2">4</span>
                    Gestisci le conversazioni
                </h4>
                <div class="ml-8 space-y-2">
                    <p class="text-gray-600"><strong>• Nuova chat:</strong> Inizia una nuova conversazione mantenendo le conversazioni precedenti nella sidebar.</p>
                    <p class="text-gray-600"><strong>• Elimina chat:</strong> Rimuovi una conversazione specifica.</p>
                    <p class="text-gray-600"><strong>• Elimina tutto:</strong> Rimuovi tutte le conversazioni salvate.</p>
                    <p class="text-gray-600"><strong>• Scarica chat:</strong> Salva la conversazione in formato Markdown sul tuo dispositivo.</p>
                </div>
            </div>
            
            <div>
                <h4 class="text-md font-medium text-gray-800 mb-2 flex items-center">
                    <span class="bg-blue-100 text-blue-800 font-bold rounded-full h-6 w-6 flex items-center justify-center mr-2">5</span>
                    Consigli per risultati ottimali
                </h4>
                <div class="ml-8 space-y-2">
                    <p class="text-gray-600"><strong>• Sii specifico</strong> nelle tue domande per ottenere risposte più precise.</p>
                    <p class="text-gray-600"><strong>• Fornisci contesto dettagliato</strong> per personalizzare l'esperienza di apprendimento.</p>
                    <p class="text-gray-600"><strong>• Prova diverse modalità</strong> per esplorare vari approcci all'apprendimento.</p>
                    <p class="text-gray-600"><strong>• Utilizza la funzione di download</strong> per conservare sessioni utili per lo studio futuro.</p>
                </div>
            </div>
        </div>
        
        <div class="mt-6 flex justify-end">
            <button id="tutorial-understand" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                Ho capito
            </button>
        </div>
    </div>
</div>

<!-- Modal confirmation dialog -->
<div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 overflow-hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
        <div class="bg-gray-50 px-6 py-4 border-b">
            <h3 class="text-lg font-medium text-gray-900" id="modal-title">Conferma</h3>
        </div>
        <div class="px-6 py-4">
            <p class="text-gray-700" id="modal-message">Sei sicuro di voler continuare?</p>
        </div>
        <div class="px-6 py-3 bg-gray-50 flex justify-end space-x-3 border-t">
            <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
                Annulla
            </button>
            <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">
                Conferma
            </button>
        </div>
    </div>
</div>

<div class="max-w-5xl mx-auto px-4 py-8">
    <!-- Header con titolo e descrizione -->
    <div class="bg-gray-50 rounded-xl shadow-lg p-8 mb-10 border border-gray-200">
        <div class="flex flex-col md:flex-row items-center justify-between">
            <div class="mb-6 md:mb-0">
                <h1 class="text-4xl font-bold text-gray-800 mb-3">Chatbot Didattico</h1>
            </div>
        </div>
        
        <!-- Tutorial Button -->
        <div class="">
            <button id="tutorial-toggle" class="flex items-center text-blue-600 hover:text-blue-800 font-medium focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <span>Come utilizzare il Chatbot Didattico</span>
            </button>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg border border-gray-200 mb-10">
        <!-- Header con menu a tendina -->
        <div class="flex flex-col md:flex-row gap-4 p-4 bg-gray-50 rounded-t-lg border-b">
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Grado scolastico</label>
                <select id="grade-select" class="w-full p-2 border rounded bg-white">
                    <option value="" disabled selected>Seleziona un'opzione</option>
                    <option value="sec1">Scuola Sec. I grado</option>
                    <option value="sec2-biennio">Scuola Sec. II grado - Biennio</option>
                    <option value="sec2-triennio">Scuola Sec. II grado - Triennio</option>
                </select>
            </div>
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Modalità</label>
                <select id="mode-select" class="w-full p-2 border rounded bg-white">
                    <option value="" disabled selected>Seleziona un'opzione</option>
                    <option value="interrogazione">Modalità Interrogazione</option>
                    <option value="interazione">Modalità Interazione</option>
                    <option value="intervista">Modalità Intervista Impossibile</option>
                </select>
            </div>
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Argomento</label>
                <select id="subject-select" class="w-full p-2 border rounded bg-white">
                    <option value="" disabled selected>Seleziona un'opzione</option>
                    <option value="ai">AI</option>
                    <option value="scienze">Scienze</option>
                    <option value="storia">Storia</option>
                </select>
            </div>
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Modello AI</label>
                <select id="model-select" class="w-full p-2 border rounded bg-white">
                    <option value="" disabled selected>Seleziona un'opzione</option>
                    <option value="gpt4o-mini">GPT-4 O Mini</option>
                    <option value="o3-mini">O3 Mini</option>
                    <option value="o3-mini-reasoning">O3 Mini con Ragionamento</option>
                    <option value="gemini">Gemini Flash</option>
                </select>
            </div>
        </div>

        <!-- Context Area -->
        <div class="p-4 bg-gray-50 border-b">
            <div class="flex gap-2">
                <textarea id="context-input" 
                          class="flex-1 p-2 border rounded resize-none bg-white" 
                          rows="3" 
                          placeholder="Descrivi la personalità del bot e il modo in cui dovrà esserti utile...."></textarea>
                <button onclick="submitContext()" 
                        class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800 self-end">
                    Inizia
                </button>
            </div>
            <div id="interview-questions" class="mt-3 hidden">
                <div class="text-sm text-gray-600 mb-2">Per l'intervista impossibile, rispondi a queste domande:</div>
                <div class="space-y-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Quale personaggio vuoi che interpreti?</label>
                        <input type="text" id="character-input" class="mt-1 p-2 w-full border rounded bg-white">
                    </div>
                    <div class="flex gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="historical-accuracy" class="mr-2">
                            <label class="text-sm text-gray-700">Comportamento storico accurato</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="period-language" class="mr-2">
                            <label class="text-sm text-gray-700">Linguaggio d'epoca</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex flex-1 min-h-[600px]">
            <!-- Chat History Sidebar -->
            <div class="w-1/4 border-r bg-gray-50 flex flex-col">
                <div class="p-3 border-b space-y-2">
                    <button onclick="startNewChat()" 
                            class="w-full px-4 py-2 bg-black text-white rounded hover:bg-gray-800">
                        Nuova Chat
                    </button>
                    <button onclick="clearAllChats()" 
                            class="w-full px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        Elimina Tutto
                    </button>
                </div>
                <div id="chat-history" class="flex-1 overflow-y-auto">
                    <!-- Chat history items will be populated here -->
                </div>
            </div>

            <!-- Chat Area -->
            <div class="flex-1 flex flex-col">
                <!-- Messages Container -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Messages will be populated here -->
                </div>

                <!-- Input Area -->
                <div class="p-4 border-t bg-white">
                    <div class="flex gap-2">
                        <textarea id="message-input" 
                                  class="flex-1 p-2 border rounded resize-none"
                                  placeholder="Finestra di input: >"
                                  rows="1"></textarea>
                        <button onclick="downloadChat()" 
                                class="px-3 py-2 bg-black text-white rounded hover:bg-gray-800 flex items-center justify-center"
                                title="Scarica chat">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button onclick="sendMessage()" 
                                class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800">
                            Invia
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Message Styling */
    .message {
        max-width: 80%;
        padding: 1rem;
        border-radius: 1rem;
        margin: 0.5rem 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.5;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .user-message {
        background-color: #e2e8f0;
        margin-left: auto;
        color: #1a202c;
        border: 1px solid #cbd5e0;
    }

    .bot-message {
        background-color: #f8fafc;
        margin-right: auto;
        color: #2d3748;
        border: 1px solid #e2e8f0;
    }

    /* Markdown Styling */
    .bot-message h1,
    .bot-message h2,
    .bot-message h3,
    .bot-message h4,
    .bot-message h5,
    .bot-message h6 {
        margin-top: 16px;
        margin-bottom: 8px;
        font-weight: 600;
        line-height: 1.25;
        color: #1a202c;
    }

    .bot-message h1 { font-size: 1.5em; }
    .bot-message h2 { font-size: 1.3em; }
    .bot-message h3 { font-size: 1.1em; }

    .bot-message p {
        margin: 8px 0;
    }

    .bot-message ul,
    .bot-message ol {
        margin: 8px 0;
        padding-left: 24px;
    }

    .bot-message li {
        margin: 4px 0;
    }

    .bot-message code {
        padding: 2px 4px;
        background: #f1f1f1;
        border-radius: 4px;
        font-family: monospace;
        color: #1a202c;
    }

    .bot-message pre {
        margin: 8px 0;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
        overflow-x: auto;
        border: 1px solid #e2e8f0;
    }

    .bot-message pre code {
        padding: 0;
        background: transparent;
    }

    .bot-message a {
        color: #3182ce;
        text-decoration: none;
    }

    .bot-message a:hover {
        text-decoration: underline;
    }

    .bot-message blockquote {
        margin: 8px 0;
        padding-left: 12px;
        border-left: 3px solid #e2e8f0;
        color: #4a5568;
    }

    /* Loading Animation */
    .loading-dots {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 12px 16px;
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin: 8px 0;
        margin-right: auto;
        max-width: 80px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .loading-dots span {
        width: 6px;
        height: 6px;
        background: #4a5568;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
        opacity: 0.7;
    }

    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    /* Scrollbar Styling */
    .overflow-y-auto::-webkit-scrollbar {
        width: 6px;
    }

    .overflow-y-auto::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .overflow-y-auto::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }

    .overflow-y-auto::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Chat History Item Styling */
    .chat-history-item {
        padding: 0.75rem;
        border-bottom: 1px solid #e2e8f0;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .chat-history-item:hover {
        background-color: #f8fafc;
    }

    .chat-history-item.active {
        background-color: #e2e8f0;
        font-weight: 500;
    }

    /* Loading and Error Messages */
    .loading-message {
        text-align: center;
        padding: 2rem;
        color: #4a5568;
        font-style: italic;
    }

    .error-message {
        text-align: center;
        padding: 2rem;
        color: #e53e3e;
        background-color: #fff5f5;
        border: 1px solid #fc8181;
        border-radius: 0.5rem;
        margin: 1rem;
    }
    
    /* Notification Animation */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-10px); }
    }

    .notification {
        animation: fadeIn 0.3s ease forwards;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transform-origin: top right;
    }

    .notification.fade-out {
        animation: fadeOut 0.3s ease forwards;
    }

    .notification-content {
        display: flex;
        align-items: center;
        padding: 1rem;
    }

    .notification-icon {
        margin-right: 0.75rem;
        flex-shrink: 0;
    }

    .notification-message {
        flex-grow: 1;
        font-size: 0.875rem;
    }

    .notification-close {
        margin-left: 0.75rem;
        flex-shrink: 0;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .notification-close:hover {
        opacity: 1;
    }

    .notification-progress {
        height: 3px;
        width: 100%;
    }

    .notification-progress-bar {
        height: 100%;
        width: 100%;
        transform-origin: left;
        animation: progress-shrink 5s linear forwards;
    }

    @keyframes progress-shrink {
        from { transform: scaleX(1); }
        to { transform: scaleX(0); }
    }
</style>

<script>
    let currentChatId = null;
    let chatMessages = [];
    let confirmCallback = null;
    
    // Show confirmation modal
    function showConfirmModal(title, message, callback) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = message;
        document.getElementById('confirm-modal').classList.remove('hidden');
        confirmCallback = callback;
    }
    
    // Hide confirmation modal
    function hideConfirmModal() {
        document.getElementById('confirm-modal').classList.add('hidden');
        confirmCallback = null;
    }

    document.getElementById('modal-cancel').addEventListener('click', hideConfirmModal);
    document.getElementById('modal-confirm').addEventListener('click', function() {
        if (confirmCallback) {
            confirmCallback();
        }
        hideConfirmModal();
    });

    // Function to show toast notifications
    function showToast(message, type = 'info') {
        const container = document.getElementById('notifications-container');
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'notification';
        
        // Set background color based on type
        let bgColor, iconSvg, progressColor;
        switch(type) {
            case 'success':
                bgColor = 'bg-green-50';
                iconSvg = '<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                progressColor = 'bg-green-500';
                break;
            case 'error':
                bgColor = 'bg-red-50';
                iconSvg = '<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                progressColor = 'bg-red-500';
                break;
            case 'warning':
                bgColor = 'bg-yellow-50';
                iconSvg = '<svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
                progressColor = 'bg-yellow-500';
                break;
            default: // info
                bgColor = 'bg-blue-50';
                iconSvg = '<svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                progressColor = 'bg-blue-500';
        }
        
        // Set notification content
        notification.innerHTML = `
            <div class="notification-content ${bgColor}">
                <div class="notification-icon">${iconSvg}</div>
                <div class="notification-message">${message}</div>
                <div class="notification-close">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
            </div>
            <div class="notification-progress">
                <div class="notification-progress-bar ${progressColor}"></div>
            </div>
        `;
        
        // Add to container
        container.appendChild(notification);
        
        // Set up close handler
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.addEventListener('click', () => {
            notification.classList.add('fade-out');
            setTimeout(() => {
                container.removeChild(notification);
            }, 300);
        });
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (container.contains(notification)) {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                }, 300);
            }
        }, 5000);
        
        return notification;
    }

    // Initialize event listeners
    document.addEventListener('DOMContentLoaded', function() {
        loadChatHistory();
        setupEventListeners();
        setupTutorialToggle();
        // Disable message input initially
        document.getElementById('message-input').disabled = true;
        // Enable context input
        document.getElementById('context-input').disabled = false;
    });

    // Set up tutorial toggle functionality
    function setupTutorialToggle() {
        const tutorialToggle = document.getElementById('tutorial-toggle');
        const tutorialModal = document.getElementById('tutorial-modal');
        const tutorialClose = document.getElementById('tutorial-close');
        const tutorialUnderstand = document.getElementById('tutorial-understand');
        
        if (tutorialToggle && tutorialModal) {
            // Apri il modal quando si clicca sul pulsante tutorial
            tutorialToggle.addEventListener('click', function() {
                tutorialModal.classList.remove('hidden');
                tutorialModal.classList.add('flex');
                
                // Animazione di apertura
                setTimeout(() => {
                    tutorialModal.style.opacity = '1';
                }, 10);
            });
            
            // Chiudi il modal quando si clicca sul pulsante di chiusura
            if (tutorialClose) {
                tutorialClose.addEventListener('click', function() {
                    tutorialModal.style.opacity = '0';
                    
                    setTimeout(() => {
                        tutorialModal.classList.remove('flex');
                        tutorialModal.classList.add('hidden');
                    }, 300);
                });
            }
            
            // Chiudi il modal quando si clicca sul pulsante "Ho capito"
            if (tutorialUnderstand) {
                tutorialUnderstand.addEventListener('click', function() {
                    tutorialModal.style.opacity = '0';
                    
                    setTimeout(() => {
                        tutorialModal.classList.remove('flex');
                        tutorialModal.classList.add('hidden');
                    }, 300);
                });
            }
            
            // Chiudi il modal quando si clicca all'esterno del contenuto
            tutorialModal.addEventListener('click', function(e) {
                if (e.target === tutorialModal) {
                    tutorialModal.style.opacity = '0';
                    
                    setTimeout(() => {
                        tutorialModal.classList.remove('flex');
                        tutorialModal.classList.add('hidden');
                    }, 300);
                }
            });
        }
    }

    function setupEventListeners() {
        // Handle enter key in message input
        const messageInput = document.getElementById('message-input');
        if (messageInput) {
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // Handle enter key in context input
        const contextInput = document.getElementById('context-input');
        if (contextInput) {
            contextInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitContext(e);
                }
            });

            // Clean up pasted text
            contextInput.addEventListener('paste', function(e) {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text');
                const cleaned = text.replace(/[\r\n]+/g, ' ').trim();
                document.execCommand('insertText', false, cleaned);
            });
        }

        // Handle mode selection change
        const modeSelect = document.getElementById('mode-select');
        if (modeSelect) {
            modeSelect.addEventListener('change', function() {
                const contextInput = document.getElementById('context-input');
                const messageInput = document.getElementById('message-input');
                const interviewQuestions = document.getElementById('interview-questions');
                
                if (this.value === 'interrogazione') {
                    contextInput.placeholder = 'Descrivi l\'argomento specifico su cui vuoi essere interrogato...';
                    messageInput.disabled = true;
                    contextInput.disabled = false;
                    interviewQuestions.classList.add('hidden');
                } else if (this.value === 'intervista') {
                    contextInput.placeholder = 'Informazioni aggiuntive sul personaggio e il contesto storico (opzionale)...';
                    messageInput.disabled = true;
                    contextInput.disabled = false;
                    interviewQuestions.classList.remove('hidden');
                } else {
                    contextInput.placeholder = 'Descrivi la personalità del bot e il modo in cui dovrà esserti utile....';
                    messageInput.disabled = true;
                    contextInput.disabled = false;
                    interviewQuestions.classList.add('hidden');
                }
            });
        }

        // Handle submit context button
        const submitButton = document.querySelector('button[onclick="submitContext()"]');
        if (submitButton) {
            submitButton.removeAttribute('onclick');
            submitButton.addEventListener('click', function(e) {
                e.preventDefault();
                submitContext(e);
            });
        }

        // Handle send message button
        const sendButton = document.querySelector('button[onclick="sendMessage()"]');
        if (sendButton) {
            sendButton.removeAttribute('onclick');
            sendButton.addEventListener('click', function(e) {
                e.preventDefault();
                sendMessage();
            });
        }

        // Handle model change
        const modelSelect = document.getElementById('model-select');
        if (modelSelect) {
            modelSelect.addEventListener('change', function(e) {
                updateModel(e.target.value);
            });
        }
    }

    async function loadChatHistory() {
        try {
            const response = await fetch('/api/chat-history');
            const history = await response.json();
            updateChatHistoryUI(history);
        } catch (error) {
            console.error('Error loading chat history:', error);
        }
    }

    function updateChatHistoryUI(history) {
        const container = document.getElementById('chat-history');
        container.innerHTML = '';

        history.forEach(chat => {
            const div = document.createElement('div');
            div.className = `chat-history-item ${chat.id === currentChatId ? 'active' : ''} flex justify-between items-center p-2 hover:bg-gray-100`;
            
            // Chat title
            const titleSpan = document.createElement('span');
            titleSpan.className = 'flex-1 cursor-pointer';
            titleSpan.textContent = chat.title || 'New Chat';
            titleSpan.onclick = () => loadChat(chat.id);
            
            // Delete button
            const deleteButton = document.createElement('button');
            deleteButton.className = 'ml-2 p-1 bg-black rounded hover:bg-gray-800';
            deleteButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>`;
            deleteButton.onclick = (e) => {
                e.stopPropagation();
                showConfirmModal('Elimina Chat', 'Sei sicuro di voler eliminare questa chat?', () => deleteChat(chat.id));
            };
            
            div.appendChild(titleSpan);
            div.appendChild(deleteButton);
            container.appendChild(div);
        });
    }

    async function submitContext(event) {
        if (event) {
            event.preventDefault();
        }

        let inputs = [];
        let startButton = null;
        
        try {
            const contextInput = document.getElementById('context-input');
            const modeSelect = document.getElementById('mode-select');
            const messageInput = document.getElementById('message-input');
            
            // Special handling for interview mode
            if (modeSelect?.value === 'intervista') {
                const character = document.getElementById('character-input')?.value?.trim();
                if (!character) {
                    showToast('Per favore, specifica il personaggio da interpretare.', 'warning');
                    return;
                }

                const historicalAccuracy = document.getElementById('historical-accuracy').checked;
                const periodLanguage = document.getElementById('period-language').checked;
                
                // Build context for interview mode
                let interviewContext = `Interpreta il personaggio storico: ${character}.\n`;
                if (historicalAccuracy) {
                    interviewContext += 'Mantieni un comportamento accurato al periodo storico.\n';
                }
                if (periodLanguage) {
                    interviewContext += 'Usa un linguaggio tipico dell\'epoca.\n';
                }

                // Add any additional context
                const additionalContext = contextInput?.value?.trim();
                if (additionalContext) {
                    interviewContext += '\nInformazioni aggiuntive:\n' + additionalContext;
                }

                contextInput.value = interviewContext;
            } else {
                const context = contextInput?.value?.trim() || '';
                if (!context) {
                    if (modeSelect?.value === 'interrogazione') {
                        showToast('Per favore inserisci l\'argomento su cui vuoi essere interrogato.', 'warning');
                    } else {
                        showToast('Per favore descrivi la personalità del bot.', 'warning');
                    }
                    return;
                }
            }

            const gradeSelect = document.getElementById('grade-select');
            const subjectSelect = document.getElementById('subject-select');
            const modelSelect = document.getElementById('model-select');
            startButton = document.querySelector('button[onclick="submitContext()"]');

            // Validate all required fields
            if (!gradeSelect?.value || !modeSelect?.value || !subjectSelect?.value || !modelSelect?.value) {
                showToast('Per favore seleziona tutte le opzioni prima di iniziare.', 'warning');
                return;
            }

            // Add loading animation to chat messages
            const messagesContainer = document.getElementById('chat-messages');
            if (messagesContainer) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading-dots';
                loadingDiv.innerHTML = '<span></span><span></span><span></span>';
                messagesContainer.appendChild(loadingDiv);
                // Scroll to loading animation
                loadingDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }

            // Disable inputs while processing
            inputs = [contextInput, gradeSelect, modeSelect, subjectSelect, modelSelect].filter(Boolean);
            inputs.forEach(input => input.disabled = true);
            if (startButton) startButton.disabled = true;

            let data;
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        message: modeSelect.value === 'interrogazione' ? 'START_INTERROGATION' :
                               modeSelect.value === 'intervista' ? 'START_INTERVIEW' : contextInput.value,
                        context: {
                            grade: gradeSelect.value,
                            mode: modeSelect.value,
                            subject: subjectSelect.value,
                            model: modelSelect.value,
                            systemPrompt: modeSelect.value === 'interrogazione' ?
                                `Sei un insegnante di ${subjectSelect.value} che sta conducendo un\'interrogazione. L\'argomento è: ${contextInput.value}. Fai domande appropriate per il livello scolastico ${gradeSelect.value}. Dopo ogni risposta dell\'utente, fornisci un feedback costruttivo, correggendo eventuali errori e incoraggiando l\'apprendimento. Poi procedi con una nuova domanda.` :
                                modeSelect.value === 'intervista' ?
                                    `Sei un chatbot che interpreta un personaggio storico in un\'intervista impossibile. ${contextInput.value}. Mantieni sempre il carattere e la personalità del personaggio nelle tue risposte, tenendo conto del grado scolastico ${gradeSelect.value} e dell\'argomento ${subjectSelect.value}. Rispondi in modo coinvolgente e educativo, mantenendo la coerenza storica.` :
                                    contextInput.value
                        },
                        chatId: currentChatId
                    })
                });

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('La risposta del server non è in formato JSON');
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    if (errorData.error && errorData.error.includes('Claude API Error')) {
                        throw new Error('Il modello Claude non è al momento disponibile. Prova a selezionare un altro modello.');
                    } else {
                        throw new Error(errorData.error || `Errore del server: ${response.status}`);
                    }
                }

                data = await response.json();
                if (!data || !data.response) {
                    throw new Error('Risposta non valida dal server');
                }
            } catch (error) {
                console.error('Error:', error);
                if (error.message.includes('Claude API Error') || error.message.includes('Claude non è al momento disponibile')) {
                    // Switch to GPT-4 automatically
                    const modelSelect = document.getElementById('model-select');
                    if (modelSelect) {
                        modelSelect.value = 'gpt4';
                        throw new Error('Il modello Claude non è disponibile. Passaggio automatico a GPT-4. Riprova.');
                    }
                }
                throw error;
            }

            // Enable message input and disable context input
            if (messageInput) messageInput.disabled = false;
            if (contextInput) contextInput.disabled = true;
            if (startButton) startButton.style.display = 'none';

            // Remove loading animation
            const loadingDots = document.querySelector('.loading-dots');
            if (loadingDots) loadingDots.remove();

            // Update UI with bot's response
            if (data.response) {
                addMessageToUI('bot', data.response);
            }
            
            // Update chat ID if new chat
            if (data.chatId) {
                currentChatId = data.chatId;
                await loadChatHistory();
            }
        } catch (error) {
            console.error('Error:', error);
            // Remove loading animation on error
            const loadingDots = document.querySelector('.loading-dots');
            if (loadingDots) loadingDots.remove();

            addMessageToUI('error', 'Si è verificato un errore: ' + error.message);
            
            // Re-enable inputs on error
            if (inputs.length) {
                inputs.forEach(input => {
                    if (input) input.disabled = false;
                });
            }
            if (startButton) startButton.disabled = false;
        }
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        if (!message) {
            showToast('Inserisci un messaggio prima di inviare.', 'info');
            return;
        }

        try {
            // Disable input and button while sending
            input.disabled = true;
            const sendButton = document.querySelector('button[onclick="sendMessage()"]');
            const downloadButton = document.querySelector('button[onclick="downloadChat()"]');
            if (sendButton) sendButton.disabled = true;
            if (downloadButton) downloadButton.disabled = true;

            // Add user message to UI
            addMessageToUI('user', message);
            input.value = '';

            // Add loading animation
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-dots';
            loadingDiv.innerHTML = '<span></span><span></span><span></span>';
            document.getElementById('chat-messages').appendChild(loadingDiv);

            // Get current context and settings
            const context = {
                grade: document.getElementById('grade-select')?.value || '',
                mode: document.getElementById('mode-select')?.value || '',
                subject: document.getElementById('subject-select')?.value || '',
                model: document.getElementById('model-select')?.value || 'gpt4',
                systemPrompt: document.getElementById('context-input')?.value || ''
            };

            console.log('Sending request with:', { message, context, chatId: currentChatId });

            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    context: context,
                    chatId: currentChatId
                })
            });

            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server response was not JSON');
            }

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }

            addMessageToUI('bot', data.response);
            
            // Update chat history if this is a new chat
            if (data.chatId !== currentChatId) {
                currentChatId = data.chatId;
                await loadChatHistory();
            }
        } catch (error) {
            console.error('Error sending message:', error);
            addMessageToUI('bot', `Si è verificato un errore: ${error.message}`);
        } finally {
            // Remove loading animation and re-enable inputs
            const loadingDots = document.querySelector('.loading-dots');
            if (loadingDots) loadingDots.remove();

            input.disabled = false;
            const sendButton = document.querySelector('button[onclick="sendMessage()"]');
            const downloadButton = document.querySelector('button[onclick="downloadChat()"]');
            if (sendButton) sendButton.disabled = false;
            if (downloadButton) downloadButton.disabled = false;
            input.focus();
        }
    }

    function addMessageToUI(role, content) {
        const container = document.getElementById('chat-messages');
        if (!container) return;

        // Remove any existing loading animation if adding a bot message
        if (role === 'bot') {
            const loadingDots = container.querySelector('.loading-dots');
            if (loadingDots) loadingDots.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}-message`;
        
        if (role === 'bot') {
            // Parse markdown for bot messages
            marked.setOptions({
                highlight: function(code, language) {
                    if (language && hljs.getLanguage(language)) {
                        try {
                            return hljs.highlight(code, { language }).value;
                        } catch (err) {}
                    }
                    return code;
                },
                breaks: true,
                gfm: true
            });
            messageDiv.innerHTML = marked.parse(content);
        } else {
            // For user messages, just handle basic formatting
            const formattedContent = content
                .replace(/\n/g, '<br>')
                .replace(/\s{2,}/g, ' &nbsp;');
            messageDiv.innerHTML = formattedContent;
        }
        
        container.appendChild(messageDiv);
        
        // Apply syntax highlighting to code blocks
        if (role === 'bot') {
            messageDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }
        
        // Smooth scroll to the latest message
        setTimeout(() => {
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }, 100);
    }

    async function updateModel(model) {
        // Handle model change logic here
        console.log('Model changed to:', model);
    }

    function startNewChat() {
        // Reset all select elements
        const selects = ['grade-select', 'mode-select', 'subject-select', 'model-select'];
        selects.forEach(id => {
            const select = document.getElementById(id);
            if (select) select.selectedIndex = 0;
        });

        // Reset context and message inputs
        const contextInput = document.getElementById('context-input');
        const messageInput = document.getElementById('message-input');
        if (contextInput) {
            contextInput.value = '';
            contextInput.disabled = false;
            contextInput.placeholder = 'Descrivi la personalità del bot e il modo in cui dovrà esserti utile....';
        }
        if (messageInput) {
            messageInput.value = '';
            messageInput.disabled = true;
        }

        // Clear chat messages
        const chatMessages = document.getElementById('chat-messages');
        if (chatMessages) chatMessages.innerHTML = '';

        // Reset current chat ID
        currentChatId = null;

        // Show the submit button if it was hidden
        const startButton = document.querySelector('button[onclick="submitContext()"]');
        if (startButton) {
            startButton.style.display = '';
            startButton.disabled = false;
        }
    }

    async function deleteChat(chatId) {
        try {
            const response = await fetch(`/api/chat/${chatId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Refresh chat history
            await loadChatHistory();
            
            // If deleted chat was current chat, start new chat
            if (chatId === currentChatId) {
                startNewChat();
            }
            showToast('Chat eliminata con successo.', 'success');
        } catch (error) {
            console.error('Error deleting chat:', error);
            showToast('Errore durante l\'eliminazione della chat: ' + error.message, 'error');
        }
    }

    async function clearAllChats() {
        showConfirmModal('Elimina Tutte le Chat', 'Sei sicuro di voler eliminare tutte le chat? Questa azione non può essere annullata.', async () => {
            try {
                // Delete all chats from the server
                const response = await fetch('/api/chats', {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Reset UI
                document.getElementById('chat-history').innerHTML = '';
                document.getElementById('chat-messages').innerHTML = '';
                
                // Reset selectors
                document.getElementById('grade-select').selectedIndex = 0;
                document.getElementById('mode-select').selectedIndex = 0;
                document.getElementById('subject-select').selectedIndex = 0;
                document.getElementById('model-select').selectedIndex = 0;
                
                // Reset inputs
                document.getElementById('context-input').value = '';
                document.getElementById('message-input').value = '';
                document.getElementById('message-input').disabled = true;
                
                // Hide interview questions if visible
                const interviewQuestions = document.getElementById('interview-questions');
                if (interviewQuestions) {
                    interviewQuestions.classList.add('hidden');
                    if (document.getElementById('character-input')) {
                        document.getElementById('character-input').value = '';
                    }
                    if (document.getElementById('historical-accuracy')) {
                        document.getElementById('historical-accuracy').checked = false;
                    }
                    if (document.getElementById('period-language')) {
                        document.getElementById('period-language').checked = false;
                    }
                }
                
                // Reset current chat ID
                currentChatId = null;
                
                // Show and enable the submit button
                const startButton = document.querySelector('button[onclick="submitContext()"]');
                if (startButton) {
                    startButton.style.display = '';
                    startButton.disabled = false;
                }
                
                // Refresh chat history
                await loadChatHistory();
                showToast('Tutte le chat sono state eliminate.', 'success');
            } catch (error) {
                console.error('Error clearing all chats:', error);
                showToast('Errore durante l\'eliminazione di tutte le chat: ' + error.message, 'error');
            }
        });
    }

    async function downloadChat() {
        if (!currentChatId) {
            showToast('Nessuna chat da scaricare.', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/api/chat/${currentChatId}`);
            const data = await response.json();
            
            // Format chat content
            let content = 'Chat Export\n\n';
            content += `Data: ${new Date().toLocaleString()}\n`;
            content += `Titolo: ${data.settings?.subject || 'Chat'}\n`;
            content += `Modalità: ${data.settings?.mode || 'Standard'}\n`;
            content += `Grado: ${data.settings?.grade || 'Non specificato'}\n\n`;
            
            data.messages.forEach(msg => {
                content += `${msg.role === 'user' ? 'Tu' : 'Bot'}: ${msg.content}\n\n`;
            });
            
            // Create and trigger download
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_${currentChatId}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showToast('Chat scaricata con successo.', 'success');
        } catch (error) {
            console.error('Error downloading chat:', error);
            showToast('Errore durante il download della chat: ' + error.message, 'error');
        }
    }

    async function loadChat(chatId) {
        try {
            // Show loading state
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '<div class="loading-message">Caricamento messaggi...</div>';

            const response = await fetch(`/api/chat/${chatId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Clear loading message and update UI with chat data
            messagesContainer.innerHTML = '';
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    if (msg.role && msg.content) {
                        addMessageToUI(msg.role, msg.content);
                    }
                });
            }
            
            // Update current chat ID and history UI
            currentChatId = chatId;
            await loadChatHistory();
            
            // Update settings if available
            if (data.settings) {
                const settings = {
                    'grade-select': data.settings.grade,
                    'mode-select': data.settings.mode,
                    'subject-select': data.settings.subject,
                    'model-select': data.settings.model || 'gpt4',
                    'context-input': data.settings.systemPrompt
                };

                // Update each setting if the element exists
                Object.entries(settings).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = value || '';
                    }
                });
            }
        } catch (error) {
            console.error('Error loading chat:', error);
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `<div class="error-message">Errore nel caricamento della chat: ${error.message}</div>`;
        }
    }
</script>
{% endblock %}
